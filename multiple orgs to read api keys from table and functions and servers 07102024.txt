# Function to get SQL connection
function Get-SqlConnection {
    param (
        [string]$sqlServer,  # SQL Server name
        [string]$database    # Database name
    )
    $SQLConn = New-Object System.Data.SqlClient.SqlConnection
    $SQLConn.ConnectionString = "Server=$sqlServer;Database=$database;Trusted_Connection=True;"  # Connection string
    $SQLConn.Open()  # Open the connection
    return $SQLConn
}

# Function to get API keys for all organizations from the database
function Get-ApiKeys {
    param (
        [System.Data.SqlClient.SqlConnection]$SQLConn  # SQL Connection object
    )
    $apiKeys = @{}  # Initialize a hashtable to store API keys
    $query = "SELECT OrgName, PublicKey, PrivateKey FROM MongoDB.DimOrganization"  # Query to fetch keys
    $cmd = $SQLConn.CreateCommand()  # Create a SQL command
    $cmd.CommandText = $query  # Set the query
    $reader = $cmd.ExecuteReader()  # Execute the query and get the reader
    try {
        while ($reader.Read()) {
            $orgName = $reader["OrgName"]
            $apiKeys[$orgName] = @($reader["PublicKey"], $reader["PrivateKey"])  # Read keys and store in hashtable
        }
    } finally {
        $reader.Close()  # Ensure the reader is closed
    }
    if ($apiKeys.Count -eq 0) {
        throw "No API keys found."  # Throw an error if no keys are found
    }
    return $apiKeys  # Return the hashtable of keys
}

# Function to get server information for all organizations from the database
function Get-ServerInfo {
    param (
        [System.Data.SqlClient.SqlConnection]$SQLConn  # SQL Connection object
    )
    $serverInfo = @{}  # Initialize a hashtable to store server info
    $query = "SELECT OrgName, HostName_Port, GroupId FROM MongoDB.MongoServers_STG"  # Query to fetch server info
    $cmd = $SQLConn.CreateCommand()  # Create a SQL command
    $cmd.CommandText = $query  # Set the query
    $reader = $cmd.ExecuteReader()  # Execute the query and get the reader
    try {
        while ($reader.Read()) {
            $orgName = $reader["OrgName"]
            if (-not $serverInfo.ContainsKey($orgName)) {
                $serverInfo[$orgName] = @()
            }
            $serverInfo[$orgName] += ,@($reader["HostName_Port"], $reader["GroupId"])  # Read server info and store in hashtable
        }
    } finally {
        $reader.Close()  # Ensure the reader is closed
    }
    return $serverInfo  # Return the hashtable of server info
}

# Function to invoke MongoDB Atlas API and get performance data
function Invoke-MongoDBAtlasAPI {
    param (
        [string]$GroupId,         # Group ID for MongoDB Atlas
        [string]$SourceServer,    # Source server for the API call
        [PSCredential]$credential # Credentials for API authentication
    )
    $currentDate = Get-Date
    $startDate = $currentDate.AddDays(-1).Date  # Start date for the API query
    $endDate = $currentDate.Date.AddDays(1)  # End date for the API query
    $startDateISO = $startDate.ToString("yyyy-MM-ddTHH:mm:ssZ")  # Format start date to ISO
    $endDateISO = $endDate.ToString("yyyy-MM-ddTHH:mm:ssZ")  # Format end date to ISO

    $apiURL = "https://cloud.mongodb.com/api/atlas/v2/groups/$GroupId/processes/$SourceServer/measurements?granularity=PT1H&start=$startDateISO&end=$endDateISO"  # API URL
    $headers = @{
        "Accept" = "application/vnd.atlas.2023-02-01+json"
    }
    return Invoke-RestMethod -Uri $apiURL -Credential $credential -Headers $headers  # Call the API and return the result
}

# Combined function to convert JSON data to DataTable and insert it into SQL Server
function ConvertAndInsertData {
    param (
        [psobject]$data,       # JSON data from API
        [string]$sqlServer,    # SQL Server name
        [string]$database      # Database name
    )

    # Create a new DataTable with the required columns
    $dataTable = New-Object System.Data.DataTable
    $dataTable.Columns.Add("groupId", [System.String])
    $dataTable.Columns.Add("hostId", [System.String])
    $dataTable.Columns.Add("processId", [System.String])
    $dataTable.Columns.Add("name", [System.String])
    $dataTable.Columns.Add("timestamp", [System.DateTime])
    $dataTable.Columns.Add("value", [System.String])
    $dataTable.Columns.Add("units", [System.String])

    if ($null -eq $data.measurements) {
        throw "The 'measurements' property is missing or null in the provided data."  # Throw error if no measurements
    }

    foreach ($measurement in $data.measurements) {
        $name = $measurement.name  # Measurement name
        foreach ($dataPoint in $measurement.dataPoints) {
            $row = $dataTable.NewRow()  # Create a new row in the DataTable
            $row["groupId"] = $data.groupId
            $row["hostId"] = $data.hostId
            $row["processId"] = $data.processId
            $row["name"] = $name
            $row["timestamp"] = [DateTime]$dataPoint.timestamp
            $row["value"] = [string]$dataPoint.value
            $row["units"] = [string]$dataPoint.units
            $dataTable.Rows.Add($row)  # Add the row to the DataTable
        }
    }

    $sqlConnectionString = "Server=$sqlServer;Database=$database;Trusted_Connection=True;"  # SQL connection string
    $sqlConnection = New-Object System.Data.SqlClient.SqlConnection $sqlConnectionString
    try {
        $sqlConnection.Open()  # Open the SQL connection
        $bulkCopy = New-Object System.Data.SqlClient.SqlBulkCopy $sqlConnection
        $bulkCopy.DestinationTableName = "MongoDB.PerformanceMetrics_STG"  # Destination table
        $bulkCopy.BatchSize = 1000  # Batch size for bulk copy

        $bulkCopy.WriteToServer($dataTable)  # Write the DataTable to the SQL Server
    } finally {
        $sqlConnection.Close()  # Ensure the SQL connection is closed
    }
}

# Main script
try {
    $sqlServer = "DBADWHTest"
    $database = "DBAWarehouse"

    # Get SQL connection
    $SQLConn = Get-SqlConnection -sqlServer $sqlServer -database $database

    # Fetch API keys and server info for all organizations
    $apiKeys = Get-ApiKeys -SQLConn $SQLConn
    $serverInfo = Get-ServerInfo -SQLConn $SQLConn

    foreach ($orgName in $apiKeys.Keys) {
        $keys = $apiKeys[$orgName]
        $username = $keys[0]
        $password = ConvertTo-SecureString $keys[1] -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential ($username, $password)  # Create PSCredential object

        if ($serverInfo.ContainsKey($orgName)) {
            $servers = $serverInfo[$orgName]
            foreach ($server in $servers) {
                $SourceServer = $server[0]
                $GroupId = $server[1]

                # Call MongoDB Atlas API
                $data = Invoke-MongoDBAtlasAPI -GroupId $GroupId -SourceServer $SourceServer -credential $credential

                # Convert and insert data into SQL
                ConvertAndInsertData -data $data -sqlServer $sqlServer -database $database
            }
        } else {
            Write-Warning "No servers found for organization $orgName"
        }
    }
} catch {
    Write-Error "An error occurred: $_"  # Catch and display errors
} finally {
    if ($SQLConn -and $SQLConn.State -eq 'Open') { $SQLConn.Close() }  # Ensure SQL connection is closed
}
