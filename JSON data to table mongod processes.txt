
# Function to insert data into SQL Server table using SqlBulkCopy
function Insert-DataIntoSqlServer {
    param (
        [string]$sqlConnectionString,
        [object]$data
    )

    # Create a SqlConnection object
    $sqlConnection = New-Object System.Data.SqlClient.SqlConnection($sqlConnectionString)

    # Open the SQL connection
    $sqlConnection.Open()

    # Create a DataTable to hold the data
    $dataTable = New-Object System.Data.DataTable
    $dataTable.Columns.Add("hostname_port", [System.String])
    $dataTable.Columns.Add("projectId", [System.String])
    $dataTable.Columns.Add("replicaSetName", [System.String])
    $dataTable.Columns.Add("nodeType", [System.String])
    $dataTable.Columns.Add("version", [System.String])
    $dataTable.Columns.Add("clusterCreated", [System.DateTime])


    # Add rows to the DataTable
    $data.results | ForEach-Object {
        $row = $dataTable.NewRow()
        $row["hostname_port"] = $_.id
        $row["projectId"] = $_.groupId
        $row["replicaSetName"] = $_.replicaSetName
        $row["nodeType"] = $_.typeName
        $row["version"] = $_.version
        $row["clusterCreated"] = [datetime]$_.created
        $dataTable.Rows.Add($row) | Out-Null
    }

    # Create a SqlBulkCopy object
    $bulkCopy = New-Object System.Data.SqlClient.SqlBulkCopy($sqlConnection)

    # Set the destination table name
    $bulkCopy.DestinationTableName = "MongoDB.MongoServers_STG"

    # Set the batch size (optional)
    $bulkCopy.BatchSize = 1000

    # Write the data to the SQL Server table
    $bulkCopy.WriteToServer($dataTable)

    # Close the SQL connection
    $sqlConnection.Close()

    Write-Output "Data inserted into SQL Server table successfully."
}

# Define SQL Server connection details
$sqlServer = "LOUSQLWTS5038"
$database = "DBAWarehouse"


# Fetch API Keys from DimOrganization table

        $SQLConn = New-Object System.Data.SQLClient.SQLConnection
        $SQLConn.ConnectionString = "server=$sqlServer;database=$database;trusted_connection=true;"
        $SQLConn.Open()


        $SQLCmd = New-Object System.Data.SQLClient.SQLCommand
        $SQLCmd.Connection = $SQLConn
        $SQLCmd.CommandText = "SELECT 
                PublicKey,
                PrivateKey,
                Group_ID
            FROM MongoDB.DimOrganization 
            WHERE OrgName = 'CAPE'"
        
        $ParamRset = $SQLCmd.ExecuteReader()

        $ParamRset.Read() | Out-Null
        $PubKey = $ParamRset[0]
        $PriKey = $ParamRset[1]
        $GroupId = $ParamRset[2]

        $ParamRset.Dispose()
        $ParamRset.Close()
        $SQLCmd.Dispose()

# truncate staging table

$SQLCmd = New-Object System.Data.SQLClient.SQLCommand
        $SQLCmd.Connection = $SQLConn
        $SQLCmd.CommandText = "truncate table MongoDB.MongoServers_STG"
        $SQLCmd.ExecuteNonQuery() | Out-Null 
        $SQLCmd.Dispose()
        $SQLConn.Close()
        $SQLConn.Dispose()

$username = "$PubKey"
$password = ConvertTo-SecureString "$PriKey" -AsPlainText -Force
$groupid = "$GroupId"
$credential = New-Object System.Management.Automation.PSCredential($username, $password)

$apiURL = "https://cloud.mongodb.com/api/atlas/v2/groups/$groupid/processes"
$headers = @{
    "Accept" = "application/vnd.atlas.2023-02-01+json"
}
$jsonData = Invoke-RestMethod -Uri $apiURL  -Credential $credential  -Headers $headers

# Create the SQL Server connection string
$sqlConnectionString = "server=$sqlServer;database=$database;trusted_connection=true;"

# Insert data into SQL Server table using bulk copy
Insert-DataIntoSqlServer -sqlConnectionString $sqlConnectionString -data $jsonData


